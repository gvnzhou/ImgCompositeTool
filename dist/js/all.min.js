function getLeft(t){var e=t.offsetLeft;return null!=t.offsetParent&&(e+=this.getLeft(t.offsetParent)),e}function getTop(t){var e=t.offsetTop;return null!=t.offsetParent&&(e+=this.getTop(t.offsetParent)),e}function saveImg(t){document.getElementById("preview_img").innerHTML="";var e=document.getElementById(t);if(e.getContext){var n=e.getContext("2d"),s=document.getElementById("img_list").getElementsByClassName("ofscanvas");n.clearRect(0,0,e.width,e.height);for(var i=0;i<s.length;i++){var a,h,o,r;a=getLeft(s[i])-getLeft(e),h=getTop(s[i])-getTop(e),o=s[i].offsetWidth,r=s[i].offsetHeight,n.drawImage(s[i],a,h,o,r)}var l=e.toDataURL("image/png",.9),g=document.createElement("img");g.src=l,document.getElementById("preview_img").appendChild(g)}}function main(){for(var t=0;t<aImg.length;t++)aImg[t].onmousedown=init}function init(t){var e=getCss(this,"left"),n=getCss(this,"top"),s=t.clientX,i=t.clientY;flag=!0,++zIndex,this.style.zIndex=zIndex;var a;a=this.cloneNode(),a.className+=" sImg",this.parentNode.appendChild(a),a.onmousemove=function(t){t.preventDefault(),flag&&(this.style.left=parseInt(e)+t.clientX-s+"px",this.style.top=parseInt(n)+t.clientY-i+"px")},a.onmouseup=newOsc}function newOsc(t){var e=this;e.onmousemove=null,flag=!1;var n=0,s=1,i=!1,a=!1,h=!1,o=getLeft(e)-getLeft(canvas)+e.width/2,r=getTop(e)-getTop(canvas)+e.height/2;if(i=cimgIsArea(o,r)){var l=imgInOfc(e),g=l.canvas,d=l.context;canvas.onselectstart=g.onselectstart=function(t){return!1},g.onmouseover=function(t){drawRbtn(e,d)},g.onmouseleave=function(t){var n=this;delRbtn(n,e,d)},g.onmousedown=function(t){var s=t.clientX,i=t.clientY,o=getCss(this,"left"),r=getCss(this,"top");flag=!0,++zIndex,this.style.zIndex=zIndex;var l=t.offsetX-this.width/2,g=t.offsetY-this.height/2,c=convertCoor(l,g,n);h=RTIsDown(e,c.x,c.y),a=imgIsDown(e,c.x,c.y),h&&(this.style.cursor="crosshair"),a&&(this.style.cursor="move"),this.onmousemove=function(t){if(a)flag&&(this.style.cursor="move",this.style.left=parseInt(o)+t.clientX-s+"px",this.style.top=parseInt(r)+t.clientY-i+"px");else if(h){var l=t.offsetX-this.width/2,g=t.offsetY-this.height/2;this.style.cursor="crosshair";var c=convertCoor(l,g,n);newR=Math.atan2(c.x,-c.y),n+=newR,d.clearRect(-this.width/2,-this.height/2,this.width,this.height),d.rotate(newR),d.drawImage(e,-parseInt(getCss(e,"width"))/2,-parseInt(getCss(e,"height"))/2,parseInt(getCss(e,"width")),parseInt(getCss(e,"height"))),drawRbtn(e,d)}},this.onmouseup=function(t){flag=!1,h=!1,a=!1,this.style.cursor="auto"}},g.onmousewheel=g.onwheel=function(t){var i=this,a=parseInt(getCss(this,"width")),h=parseInt(getCss(this,"height")),o=parseInt(getCss(this,"left")),r=parseInt(getCss(this,"top"));t.wheelDelta=t.wheelDelta?t.wheelDelta:-40*t.deltaY,t.wheelDelta>0?(s=1.2,e.style.width=parseInt(getCss(e,"width"))*s+"px",e.style.height=parseInt(getCss(e,"height"))*s+"px",this.width=1.45*parseInt(e.style.width),this.height=1.45*parseInt(e.style.height),this.style.left=o+a/2-parseInt(getCss(this,"width"))/2+"px",this.style.top=r+h/2-parseInt(getCss(this,"height"))/2+"px",drawImg(i,d,e,n),drawRbtn(e,d)):(s=.8,e.style.width=parseInt(getCss(e,"width"))*s+"px",e.style.height=parseInt(getCss(e,"height"))*s+"px",this.width=1.45*parseInt(e.style.width),this.height=1.45*parseInt(e.style.height),this.style.left=o+a/2-parseInt(getCss(this,"width"))/2+"px",this.style.top=r+h/2-parseInt(getCss(this,"height"))/2+"px",drawImg(i,d,e,n),drawRbtn(e,d))}}else this.parentNode.removeChild(this)}function $(t){return document.getElementById(t)}function getCss(t,e){return t.currentStyle?t.currentStyle[e]:document.defaultView.getComputedStyle(t,null)[e]}function getLeft(t){var e=t.offsetLeft;return null!=t.offsetParent&&(e+=this.getLeft(t.offsetParent)),e}function getTop(t){var e=t.offsetTop;return null!=t.offsetParent&&(e+=this.getTop(t.offsetParent)),e}function getPointDistance(t,e){var n=t.x,s=t.y,i=e.x,a=e.y,h=Math.sqrt((i-n)*(i-n)+(a-s)*(a-s));return h}function cimgIsArea(t,e){return t>0&&t<canvas.width&&e>0&&e<canvas.height}function RTIsDown(t,e,n){var s={x:0,y:-t.height/2-Selected_Round_R},i=getPointDistance({x:e,y:n},s)<=Selected_Round_R;return i}function imgIsDown(t,e,n){return-t.width/2<=e&&e<=t.width/2&&-t.height/2<n&&n<=t.height/2}function imgInOfc(t){var e=document.createElement("canvas"),n=e.getContext("2d");return e.className+=" ofscanvas",e.width=1.5*t.width,e.height=1.5*t.height,n.translate(e.width/2,e.height/2),n.drawImage(t,-t.width/2,-t.height/2,t.width,t.height),drawRbtn(t,n),t.parentNode.appendChild(e),e.style.position="absolute",e.style.left=getCss(t,"left"),e.style.top=getCss(t,"top"),t.style.visibility="hidden",{canvas:e,context:n}}function convertCoor(t,e,n){if(0!=n){var s=Math.sqrt(t*t+e*e),i=Math.atan2(e,t),a=i-n;t=s*Math.cos(a),e=s*Math.sin(a)}return{x:t,y:e}}function drawRbtn(t,e){e.beginPath(),e.arc(0,-t.height/2-Selected_Round_R,Selected_Round_R,0,2*Math.PI),e.closePath(),e.strokeStyle="#FF0000",e.stroke()}function delRbtn(t,e,n){n.clearRect(-t.width/2,-t.height/2,t.width,(t.height-e.height)/2)}function drawImg(t,e,n,s){e.translate(t.width/2,t.height/2),e.clearRect(-t.width/2,-t.height/2,t.width,t.height),e.rotate(s),e.drawImage(n,-parseInt(getCss(n,"width"))/2,-parseInt(getCss(n,"height"))/2,parseInt(getCss(n,"width")),parseInt(getCss(n,"height")))}function $(t){return document.querySelector(t)}function $$(t){return document.querySelectorAll(t)}function getCss(t,e){return t.currentStyle?t.currentStyle[e]:document.defaultView.getComputedStyle(t,null)[e]}function getLeft(t){var e=t.offsetLeft;return null!=t.offsetParent&&(e+=this.getLeft(t.offsetParent)),e}function getTop(t){var e=t.offsetTop;return null!=t.offsetParent&&(e+=this.getTop(t.offsetParent)),e}function Img(t){this.flag=!1,this.ele=t,this.cImg=this.ele.cloneNode(),this.cImg.className+=" sImg",this.ele.parentNode.appendChild(this.cImg)}function isEditArea(t,e){return t>0&&t<canvas.width&&e>0&&e<canvas.height}function getPointDistance(t,e){var n=t.x,s=t.y,i=e.x,a=e.y,h=Math.sqrt((i-n)*(i-n)+(a-s)*(a-s));return h}function RTIsDown(t,e,n){var s={x:0,y:-t.height/2-Selected_Round_R},i=getPointDistance({x:e,y:n},s)<=Selected_Round_R;return i}function imgIsDown(t,e,n){return-t.width/2<=e&&e<=t.width/2&&-t.height/2<n&&n<=t.height/2}function imgInOfc(t){var e=document.createElement("canvas"),n=e.getContext("2d");return e.className+=" ofscanvas",e.width=1.5*t.width,e.height=1.5*t.height,n.translate(e.width/2,e.height/2),n.drawImage(t,-t.width/2,-t.height/2,t.width,t.height),drawRbtn(t,n),t.parentNode.appendChild(e),e.style.position="absolute",e.style.left=getCss(t,"left"),e.style.top=getCss(t,"top"),t.style.visibility="hidden",{canvas:e,context:n}}function convertCoor(t,e,n){if(0!=n){var s=Math.sqrt(t*t+e*e),i=Math.atan2(e,t),a=i-n;t=s*Math.cos(a),e=s*Math.sin(a)}return{x:t,y:e}}function drawRbtn(t,e){e.beginPath(),e.arc(0,-t.height/2-Selected_Round_R,Selected_Round_R,0,2*Math.PI),e.closePath(),e.strokeStyle="#FF0000",e.stroke()}function delRbtn(t,e,n){n.clearRect(-t.width/2,-t.height/2,t.width,(t.height-e.height)/2)}function drawImg(t,e,n,s){e.translate(t.width/2,t.height/2),e.clearRect(-t.width/2,-t.height/2,t.width,t.height),e.rotate(s),e.drawImage(n,-parseInt(getCss(n,"width"))/2,-parseInt(getCss(n,"height"))/2,parseInt(getCss(n,"width")),parseInt(getCss(n,"height")))}window.onload=main;var canvas=$("drawing"),context=canvas.getContext("2d"),aImg=$("img_list").getElementsByTagName("img"),flag=!1,zIndex=0,Selected_Round_R=10,eventUtil={addHandler:function(t,e,n,s){t.addEventListener?t.addEventListener(e,n,s):t.attachEvent?t.attachEvent("on"+e,n):t["on"+e]=n},removeHandler:function(t,e,n){t.removeEventListener?t.removeEventListener(e,n,boolean):t.detachEvent?t.detachEvent("on"+e,n):t["on"+e]=null}},canvas=$("#drawing"),context=canvas.getContext("2d"),Selected_Round_R=10;Img.prototype.initImg=function(t){var e=this,n=getCss(this.ele,"left"),s=getCss(this.ele,"top"),i=t.clientX,a=t.clientY;this.flag=!0,++zIndex,this.cImg.style.zIndex=zIndex,eventUtil.addHandler(this.cImg,"mousemove",function(t){t.preventDefault(),e.flag&&(this.style.left=parseInt(n)+t.clientX-i+"px",this.style.top=parseInt(s)+t.clientY-a+"px")},!1),eventUtil.addHandler(this.cImg,"mouseup",this.newOsc,!1)},Img.prototype.newOsc=function(){var t=this,e=0,n=1,s=!1,i=!1;this.flag=!1;var a=getLeft(this)-getLeft(canvas)+this.width/2,h=getTop(this)-getTop(canvas)+this.height/2;if(isEditArea(a,h)){var o=imgInOfc(this),r=o.canvas,l=o.context;canvas.onselectstart=r.onselectstart=function(t){return!1},eventUtil.addHandler(r,"mouseover",function(e){drawRbtn(t,l)},!1),eventUtil.addHandler(r,"mouseleave",function(e){delRbtn(this,t,l)},!1),eventUtil.addHandler(r,"mousedown",function(n){var a=n.clientX,h=n.clientY,o=getCss(this,"left"),r=getCss(this,"top");flag=!0,++zIndex,this.style.zIndex=zIndex;var g=n.offsetX-this.width/2,d=n.offsetY-this.height/2,c=convertCoor(g,d,e);i=RTIsDown(t,c.x,c.y),s=imgIsDown(t,c.x,c.y),i&&(this.style.cursor="crosshair"),s&&(this.style.cursor="move"),this.onmousemove=function(n){if(s)flag&&(this.style.cursor="move",this.style.left=parseInt(o)+n.clientX-a+"px",this.style.top=parseInt(r)+n.clientY-h+"px");else if(i){var g=n.offsetX-this.width/2,d=n.offsetY-this.height/2;this.style.cursor="crosshair";var c=convertCoor(g,d,e);newR=Math.atan2(c.x,-c.y),e+=newR,l.clearRect(-this.width/2,-this.height/2,this.width,this.height),l.rotate(newR),l.drawImage(t,-parseInt(getCss(t,"width"))/2,-parseInt(getCss(t,"height"))/2,parseInt(getCss(t,"width")),parseInt(getCss(t,"height"))),drawRbtn(t,l)}},this.onmouseup=function(t){flag=!1,i=!1,s=!1,this.style.cursor="auto"}},!1),r.onmousewheel=r.onwheel=function(s){var i=this,a=parseInt(getCss(this,"width")),h=parseInt(getCss(this,"height")),o=parseInt(getCss(this,"left")),r=parseInt(getCss(this,"top"));s.wheelDelta=s.wheelDelta?s.wheelDelta:-40*s.deltaY,s.wheelDelta>0?(n=1.2,t.style.width=parseInt(getCss(t,"width"))*n+"px",t.style.height=parseInt(getCss(t,"height"))*n+"px",this.width=1.45*parseInt(t.style.width),this.height=1.45*parseInt(t.style.height),this.style.left=o+a/2-parseInt(getCss(this,"width"))/2+"px",this.style.top=r+h/2-parseInt(getCss(this,"height"))/2+"px",drawImg(i,l,t,e),drawRbtn(t,l)):(n=.8,t.style.width=parseInt(getCss(t,"width"))*n+"px",t.style.height=parseInt(getCss(t,"height"))*n+"px",this.width=1.45*parseInt(t.style.width),this.height=1.45*parseInt(t.style.height),this.style.left=o+a/2-parseInt(getCss(this,"width"))/2+"px",this.style.top=r+h/2-parseInt(getCss(this,"height"))/2+"px",drawImg(i,l,t,e),drawRbtn(t,l))}}else this.parentNode.removeChild(this)};var EDIT_MAX_NUM=10,zIndex=0,imgEditor=function(){var t=[],e=$("#saveimg");return{initImgEditor:function(){for(var e=$$("#img_list .drag-img"),n=$$("#img_list .del-icon"),s=$$(".upload-img"),i=($("#img_list"),0);i<e.length;i++)!function(i){e[i].onmousedown=function(e){t[i]=new Img(this),t[i].initImg(e)},s[i].onmouseover=function(t){n[i].style.display="block"},e[i].onmouseleave=function(t){n[i].style.display="none"}}(i);this.initToolBar()},initToolBar:function(){var t=this;eventUtil.addHandler(e,"click",function(e){t.saveImg("drawing")},!1)},saveImg:function(t){document.getElementById("preview_img").innerHTML="";var e=document.getElementById(t);if(e.getContext){var n=e.getContext("2d"),s=document.getElementById("img_list").getElementsByClassName("ofscanvas");n.clearRect(0,0,e.width,e.height);for(var i=0;i<s.length;i++){var a,h,o,r;a=getLeft(s[i])-getLeft(e),h=getTop(s[i])-getTop(e),o=s[i].offsetWidth,r=s[i].offsetHeight,n.drawImage(s[i],a,h,o,r)}var l=e.toDataURL("image/png",.9),g=document.createElement("img");g.src=l,document.getElementById("preview_img").appendChild(g)}}}}(),uploadImg=function(){var t=$("#img_list");return{initUploadBtn:function(){var e=this;eventUtil.addHandler(t,"change",function(t){"input"===t.target.nodeName.toLowerCase()&&e.readAsDataURL(t.target)},!1),eventUtil.addHandler(t,"click",function(t){if(t.target.getAttribute("data-icon"))for(var e=t.target.parentNode.childNodes,n=0;n<e.length;n++)"input"===e[n].nodeName.toLowerCase()&&e[n].click()},!1)},readAsDataURL:function(t){var e=t.files[0];if(!/image\/\w+/.test(e.type))return alert("上传一个图片，见证它的威力吧！"),!1;var n=new FileReader;n.readAsDataURL(e),n.onload=function(e){t.parentNode.style.overflow="visible",t.parentNode.innerHTML='<i class="icon-minus-sign del-icon"></i><img src="'+this.result+'" class="drag-img" />'}},init:function(){return"undefined"==typeof FileReader?(alert("你的浏览器out啦，请使用最新的浏览器体验！"),void Array.prototype.slice.call(subBtn).forEach(function(t,e){t.setAttribute("disabled","disabled")})):void this.initUploadBtn()}}}();